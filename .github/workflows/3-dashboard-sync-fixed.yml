name: üåê Dashboard Sync (Fixed)

on:
  schedule:
    - cron: '*/15 * * * *'  # Cada 15 minutos
  push:
    paths:
      - 'kraken_trades.csv'
      - 'trading_signals.csv'
      - 'orders_executed.csv'
      - 'ethusd_results.png'
      - 'trading_analytics.png'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: dashboard-sync
  cancel-in-progress: false

jobs:
  sync-to-dashboard:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout trading repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Node.js (for dashboard)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Verify files exist
        id: check_files
        run: |
          echo "üìÇ Verificando archivos para sincronizar..."
          
          files_found=0
          
          if [ -f "kraken_trades.csv" ]; then
            echo "‚úÖ kraken_trades.csv ($(wc -l < kraken_trades.csv) l√≠neas)"
            files_found=$((files_found + 1))
          fi
          
          if [ -f "trading_signals.csv" ]; then
            echo "‚úÖ trading_signals.csv ($(wc -l < trading_signals.csv) l√≠neas)"
            files_found=$((files_found + 1))
          fi
          
          if [ -f "orders_executed.csv" ]; then
            echo "‚úÖ orders_executed.csv ($(wc -l < orders_executed.csv) l√≠neas)"
            files_found=$((files_found + 1))
          fi
          
          if [ -f "ethusd_results.png" ]; then
            echo "‚úÖ ethusd_results.png"
            files_found=$((files_found + 1))
          fi
          
          if [ -f "trading_analytics.png" ]; then
            echo "‚úÖ trading_analytics.png"
            files_found=$((files_found + 1))
          fi
          
          echo "has_files=$files_found" >> $GITHUB_OUTPUT
      
      - name: Create/Update GitHub Pages branch
        if: steps.check_files.outputs.has_files > 0
        run: |
          echo "üåê Creando/actualizando rama gh-pages..."
          
          # Configurar git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Crear rama gh-pages si no existe
          if ! git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            echo "üìù Creando rama gh-pages..."
            git checkout --orphan gh-pages
            git rm -rf .
          else
            echo "üì• Obteniendo rama gh-pages existente..."
            git fetch origin gh-pages
            git checkout gh-pages
            git pull origin gh-pages
          fi
          
          # Crear estructura de directorios
          mkdir -p data images
          
          # Copiar archivos desde main
          git checkout main -- kraken_trades.csv 2>/dev/null || echo "‚ö†Ô∏è kraken_trades.csv no existe"
          git checkout main -- trading_signals.csv 2>/dev/null || echo "‚ö†Ô∏è trading_signals.csv no existe"
          git checkout main -- orders_executed.csv 2>/dev/null || echo "‚ö†Ô∏è orders_executed.csv no existe"
          git checkout main -- ethusd_results.png 2>/dev/null || echo "‚ö†Ô∏è ethusd_results.png no existe"
          git checkout main -- trading_analytics.png 2>/dev/null || echo "‚ö†Ô∏è trading_analytics.png no existe"
          git checkout main -- open_orders.json 2>/dev/null || echo "‚ö†Ô∏è open_orders.json no existe"
          git checkout main -- risk_config.json 2>/dev/null || echo "‚ö†Ô∏è risk_config.json no existe"
          
          # Mover archivos a directorios apropiados
          mv *.csv data/ 2>/dev/null || true
          mv *.json data/ 2>/dev/null || true
          mv *.png images/ 2>/dev/null || true
          
          echo "‚úÖ Archivos organizados"
      
      - name: Generate metadata and index
        if: steps.check_files.outputs.has_files > 0
        run: |
          cd data 2>/dev/null || mkdir -p data && cd data
          
          # Generar metadata.json
          cat > metadata.json << 'EOF'
{
  "last_sync": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "sync_source": "github-actions",
  "run_id": "${{ github.run_id }}",
  "repository": "${{ github.repository }}",
  "files": {
    "trades": $([ -f "kraken_trades.csv" ] && tail -n +2 kraken_trades.csv | wc -l || echo 0),
    "signals": $([ -f "trading_signals.csv" ] && tail -n +2 trading_signals.csv | wc -l || echo 0),
    "orders": $([ -f "orders_executed.csv" ] && tail -n +2 orders_executed.csv | wc -l || echo 0)
  },
  "images": {
    "model_results": $([ -f "../images/ethusd_results.png" ] && echo "true" || echo "false"),
    "analytics": $([ -f "../images/trading_analytics.png" ] && echo "true" || echo "false")
  }
}
EOF
          
          # Evaluar variables
          eval "cat > metadata.json << 'EOFEVAL'
$(cat metadata.json)
EOFEVAL"
          
          cd ..
          
          # Crear index.html simple
          cat > index.html << 'HTML'
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .subtitle {
            text-align: center;
            opacity: 0.9;
            margin-bottom: 40px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card h2 {
            font-size: 1.5em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card a {
            color: #fff;
            text-decoration: none;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-block;
            margin-top: 10px;
            transition: background 0.3s ease;
        }
        .card a:hover {
            background: rgba(255,255,255,0.3);
        }
        .images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
        .images img {
            width: 100%;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            opacity: 0.8;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Trading Bot Dashboard</h1>
        <p class="subtitle">Datos en tiempo real del bot de trading automatizado</p>
        
        <div class="grid">
            <div class="card">
                <h2>üìä Datos de Trading</h2>
                <p>Accede a los archivos CSV con todos los datos:</p>
                <a href="data/kraken_trades.csv" download>üì• Trades Cerrados</a>
                <a href="data/trading_signals.csv" download>üì• Se√±ales Generadas</a>
                <a href="data/orders_executed.csv" download>üì• √ìrdenes Ejecutadas</a>
            </div>
            
            <div class="card">
                <h2>‚öôÔ∏è Estado del Sistema</h2>
                <p>Informaci√≥n del sistema y configuraci√≥n:</p>
                <a href="data/metadata.json" download>üì• Metadata</a>
                <a href="data/open_orders.json" download>üì• √ìrdenes Abiertas</a>
                <a href="data/risk_config.json" download>üì• Config Riesgo</a>
            </div>
            
            <div class="card">
                <h2>üìà Gr√°ficas</h2>
                <p>Visualizaciones del modelo y trading:</p>
                <a href="images/ethusd_results.png" target="_blank">üñºÔ∏è Resultados Modelo</a>
                <a href="images/trading_analytics.png" target="_blank">üñºÔ∏è Analytics Trading</a>
            </div>
        </div>
        
        <div class="images">
            <img src="images/ethusd_results.png" alt="Resultados LSTM" onerror="this.style.display='none'">
            <img src="images/trading_analytics.png" alt="Analytics" onerror="this.style.display='none'">
        </div>
        
        <div class="footer">
            <p>√öltima actualizaci√≥n: <span id="lastUpdate">Cargando...</span></p>
            <p>Repositorio: <a href="https://github.com/${{ github.repository }}" style="color: #fff;">GitHub</a></p>
        </div>
    </div>
    
    <script>
        fetch('data/metadata.json')
            .then(r => r.json())
            .then(data => {
                document.getElementById('lastUpdate').textContent = 
                    new Date(data.last_sync).toLocaleString('es-ES');
            })
            .catch(() => {
                document.getElementById('lastUpdate').textContent = 'Error al cargar';
            });
    </script>
</body>
</html>
HTML
          
          echo "üìù index.html y metadata creados"
      
      - name: Commit and push to gh-pages
        if: steps.check_files.outputs.has_files > 0
        run: |
          git add -A
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No hay cambios para commitear"
          else
            git commit -m "üåê Sync dashboard data [$(date +'%Y-%m-%d %H:%M UTC')]

- Trades: $([ -f data/kraken_trades.csv ] && tail -n +2 data/kraken_trades.csv | wc -l || echo 0)
- Signals: $([ -f data/trading_signals.csv ] && tail -n +2 data/trading_signals.csv | wc -l || echo 0)
- Orders: $([ -f data/orders_executed.csv ] && tail -n +2 data/orders_executed.csv | wc -l || echo 0)"
            
            git push origin gh-pages || {
              echo "‚ùå Error al hacer push"
              exit 1
            }
            
            echo "‚úÖ Dashboard sincronizado en gh-pages"
          fi
      
      - name: Enable GitHub Pages
        if: steps.check_files.outputs.has_files > 0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üåê Verificando GitHub Pages..."
          
          # Habilitar Pages via API si no est√° habilitado
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pages" \
            -d '{"source":{"branch":"gh-pages","path":"/"}}' \
            2>/dev/null || echo "‚ÑπÔ∏è Pages ya habilitado o sin permisos"
          
          echo "‚úÖ Dashboard disponible en:"
          echo "   https://${{ github.repository_owner }}.github.io/$(echo ${{ github.repository }} | cut -d'/' -f2)/"
      
      - name: Notify sync status
        if: always()
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ "${{ steps.check_files.outputs.has_files }}" != "0" ]; then
            status="‚úÖ Dashboard sincronizado"
            url="https://${{ github.repository_owner }}.github.io/$(echo ${{ github.repository }} | cut -d'/' -f2)/"
            
            msg="üåê ${status}%0A%0Aüìä Archivos: ${{ steps.check_files.outputs.has_files }}%0Aüîó ${url}"
          else
            status="‚ÑπÔ∏è Sin archivos para sincronizar"
            msg="‚ÑπÔ∏è ${status}"
          fi
          
          # Solo notificar si hubo cambios o es ejecuci√≥n manual
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] || [ "${{ steps.check_files.outputs.has_files }}" != "0" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_API}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="${msg}" \
              -d parse_mode="Markdown" || true
          fi

  verify-dashboard:
    needs: sync-to-dashboard
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Wait for Pages deployment
        run: |
          echo "‚è≥ Esperando 30s para deployment..."
          sleep 30
      
      - name: Test dashboard URL
        run: |
          URL="https://${{ github.repository_owner }}.github.io/$(echo ${{ github.repository }} | cut -d'/' -f2)/"
          
          echo "üåê Verificando: $URL"
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          
          if [ "$HTTP_CODE" == "200" ]; then
            echo "‚úÖ Dashboard accesible (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è Dashboard responde con HTTP $HTTP_CODE"
            echo "   Puede tardar unos minutos en estar disponible"
          fi
