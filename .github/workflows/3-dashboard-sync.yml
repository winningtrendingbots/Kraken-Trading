name: üåê Dashboard Sync

on:
  schedule:
    - cron: '*/15 * * * *'
  push:
    paths:
      - 'kraken_trades.csv'
      - 'trading_signals.csv'
      - 'orders_executed.csv'
      - 'ethusd_results.png'
      - 'trading_analytics.png'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: dashboard-sync
  cancel-in-progress: false

jobs:
  sync-to-dashboard:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout trading repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Verify files exist
        id: check_files
        run: |
          echo "üìÇ Verificando archivos..."
          
          files_found=0
          
          [ -f "kraken_trades.csv" ] && echo "‚úÖ kraken_trades.csv" && files_found=$((files_found + 1))
          [ -f "trading_signals.csv" ] && echo "‚úÖ trading_signals.csv" && files_found=$((files_found + 1))
          [ -f "orders_executed.csv" ] && echo "‚úÖ orders_executed.csv" && files_found=$((files_found + 1))
          [ -f "ethusd_results.png" ] && echo "‚úÖ ethusd_results.png" && files_found=$((files_found + 1))
          [ -f "trading_analytics.png" ] && echo "‚úÖ trading_analytics.png" && files_found=$((files_found + 1))
          
          echo "has_files=$files_found" >> $GITHUB_OUTPUT
      
      - name: Setup gh-pages branch
        if: steps.check_files.outputs.has_files > 0
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Crear o actualizar gh-pages
          if ! git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            echo "üìù Creando rama gh-pages..."
            git checkout --orphan gh-pages
            git rm -rf .
          else
            echo "üì• Actualizando gh-pages..."
            git fetch origin gh-pages
            git checkout gh-pages
            git pull origin gh-pages
          fi
          
          # Crear estructura
          mkdir -p data images
          
          # Copiar archivos desde main
          git checkout main -- kraken_trades.csv 2>/dev/null && mv kraken_trades.csv data/ || true
          git checkout main -- trading_signals.csv 2>/dev/null && mv trading_signals.csv data/ || true
          git checkout main -- orders_executed.csv 2>/dev/null && mv orders_executed.csv data/ || true
          git checkout main -- open_orders.json 2>/dev/null && mv open_orders.json data/ || true
          git checkout main -- risk_config.json 2>/dev/null && mv risk_config.json data/ || true
          git checkout main -- ethusd_results.png 2>/dev/null && mv ethusd_results.png images/ || true
          git checkout main -- trading_analytics.png 2>/dev/null && mv trading_analytics.png images/ || true
          
          echo "‚úÖ Archivos organizados"
      
      - name: Generate metadata
        if: steps.check_files.outputs.has_files > 0
        run: |
          # Generar metadata.json
          cat > data/metadata.json << EOF
{
  "last_sync": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "sync_source": "github-actions",
  "run_id": "${{ github.run_id }}",
  "repository": "${{ github.repository }}",
  "files": {
    "trades": $([ -f "data/kraken_trades.csv" ] && tail -n +2 data/kraken_trades.csv | wc -l || echo 0),
    "signals": $([ -f "data/trading_signals.csv" ] && tail -n +2 data/trading_signals.csv | wc -l || echo 0),
    "orders": $([ -f "data/orders_executed.csv" ] && tail -n +2 data/orders_executed.csv | wc -l || echo 0)
  },
  "images": {
    "model_results": $([ -f "images/ethusd_results.png" ] && echo "true" || echo "false"),
    "analytics": $([ -f "images/trading_analytics.png" ] && echo "true" || echo "false")
  }
}
EOF
          
          echo "üìä metadata.json generado"
      
      - name: Create index.html
        if: steps.check_files.outputs.has_files > 0
        run: |
          cat > index.html << 'HTMLEOF'
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 {
            text-align: center;
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .subtitle {
            text-align: center;
            opacity: 0.9;
            margin-bottom: 40px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); }
        .card h2 {
            font-size: 1.5em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card a {
            color: #fff;
            text-decoration: none;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-block;
            margin: 5px;
            transition: background 0.3s ease;
        }
        .card a:hover { background: rgba(255,255,255,0.3); }
        .images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
        .images img {
            width: 100%;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Trading Bot Dashboard</h1>
        <p class="subtitle">Datos en tiempo real del bot de trading</p>
        
        <div class="grid">
            <div class="card">
                <h2>üìä Datos CSV</h2>
                <a href="data/kraken_trades.csv" download>üì• Trades</a>
                <a href="data/trading_signals.csv" download>üì• Se√±ales</a>
                <a href="data/orders_executed.csv" download>üì• √ìrdenes</a>
            </div>
            
            <div class="card">
                <h2>‚öôÔ∏è Config</h2>
                <a href="data/metadata.json" download>üì• Metadata</a>
                <a href="data/open_orders.json" download>üì• √ìrdenes Abiertas</a>
                <a href="data/risk_config.json" download>üì• Risk Config</a>
            </div>
            
            <div class="card">
                <h2>üìà Gr√°ficas</h2>
                <a href="images/ethusd_results.png" target="_blank">üñºÔ∏è Modelo LSTM</a>
                <a href="images/trading_analytics.png" target="_blank">üñºÔ∏è Analytics</a>
            </div>
        </div>
        
        <div class="images">
            <img src="images/ethusd_results.png" alt="Resultados" onerror="this.style.display='none'">
            <img src="images/trading_analytics.png" alt="Analytics" onerror="this.style.display='none'">
        </div>
        
        <div class="footer">
            <p>√öltima actualizaci√≥n: <span id="lastUpdate">Cargando...</span></p>
        </div>
    </div>
    
    <script>
        fetch('data/metadata.json')
            .then(r => r.json())
            .then(data => {
                document.getElementById('lastUpdate').textContent = 
                    new Date(data.last_sync).toLocaleString('es-ES');
            })
            .catch(() => {
                document.getElementById('lastUpdate').textContent = 'Error';
            });
    </script>
</body>
</html>
HTMLEOF
          
          echo "üìù index.html creado"
      
      - name: Commit and push
        if: steps.check_files.outputs.has_files > 0
        run: |
          git add -A
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Sin cambios"
          else
            TRADES=$([ -f data/kraken_trades.csv ] && tail -n +2 data/kraken_trades.csv | wc -l || echo 0)
            
            git commit -m "üåê Dashboard sync [$(date +'%Y-%m-%d %H:%M UTC')]

Trades: $TRADES | Archivos: ${{ steps.check_files.outputs.has_files }}"
            
            git push origin gh-pages
            
            echo "‚úÖ Dashboard sincronizado"
            echo "üåê URL: https://${{ github.repository_owner }}.github.io/$(basename ${{ github.repository }})"
          fi
      
      - name: Notify
        if: always() && steps.check_files.outputs.has_files > 0
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          URL="https://${{ github.repository_owner }}.github.io/$(basename ${{ github.repository }})"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_API}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="üåê Dashboard sync OK%0A%0Aüîó ${URL}" \
            -d parse_mode="Markdown" || true
