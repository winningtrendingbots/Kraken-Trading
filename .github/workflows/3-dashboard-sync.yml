name: üåê Dashboard Sync

on:
  schedule:
    - cron: '*/30 * * * *'  # Cada 30 minutos
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Forzar sincronizaci√≥n completa'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: dashboard-sync
  cancel-in-progress: true

jobs:
  sync-to-dashboard:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout trading repo
        uses: actions/checkout@v4
        with:
          path: trading
          fetch-depth: 1
      
      - name: Checkout dashboard repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.DASHBOARD_REPO || format('{0}/{1}-dashboard', github.repository_owner, github.event.repository.name) }}
          path: dashboard
          token: ${{ secrets.DASHBOARD_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 1
      
      - name: Create data directory
        run: |
          cd dashboard
          mkdir -p data
          echo "üìÅ Directorio data creado/verificado"
      
      - name: Sync CSV files
        run: |
          echo "üîÑ Sincronizando archivos CSV..."
          
          # Funci√≥n para copiar con verificaci√≥n
          copy_if_exists() {
            src="trading/$1"
            dst="dashboard/data/$1"
            
            if [ -f "$src" ]; then
              cp "$src" "$dst"
              echo "‚úÖ Copiado: $1 ($(wc -l < $src) l√≠neas)"
            else
              echo "‚ö†Ô∏è No existe: $1"
              # Crear archivo vac√≠o con headers si no existe
              if [ ! -f "$dst" ]; then
                case "$1" in
                  "kraken_trades.csv")
                    echo "timestamp,txid,side,entry_price,close_price,volume,tp,sl,close_reason,time_open_min,pnl_usd,pnl_%" > "$dst"
                    ;;
                  "trading_signals.csv")
                    echo "timestamp,current_price,pred_high,pred_low,pred_close,pred_change_%,atr,volatility,trend,signal,confidence" > "$dst"
                    ;;
                  "orders_executed.csv")
                    echo "timestamp,txid,side,entry_price,volume,tp,sl,confidence,order_executed,order_type" > "$dst"
                    ;;
                esac
                echo "   üìù Creado archivo vac√≠o con headers"
              fi
            fi
          }
          
          copy_if_exists "kraken_trades.csv"
          copy_if_exists "trading_signals.csv"
          copy_if_exists "orders_executed.csv"
          
          # Copiar open_orders.json si existe
          if [ -f "trading/open_orders.json" ]; then
            cp trading/open_orders.json dashboard/data/open_orders.json
            echo "‚úÖ Copiado: open_orders.json"
          fi
      
      - name: Generate metadata
        run: |
          cd dashboard/data
          
          cat > metadata.json << EOF
{
  "last_sync": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "sync_source": "github-actions",
  "run_id": "${{ github.run_id }}",
  "files": {
    "trades": $([ -f "kraken_trades.csv" ] && wc -l < kraken_trades.csv || echo 0),
    "signals": $([ -f "trading_signals.csv" ] && wc -l < trading_signals.csv || echo 0),
    "orders": $([ -f "orders_executed.csv" ] && wc -l < orders_executed.csv || echo 0)
  }
}
EOF
          
          echo "üìä Metadata generada:"
          cat metadata.json
      
      - name: Check for changes
        id: changes
        run: |
          cd dashboard
          
          if git diff --quiet data/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No hay cambios que sincronizar"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Cambios detectados"
            git diff --stat data/
          fi
      
      - name: Commit and push
        if: steps.changes.outputs.has_changes == 'true' || github.event.inputs.force_sync == 'true'
        run: |
          cd dashboard
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add data/*.csv data/*.json 2>/dev/null || true
          
          # Generar mensaje de commit con stats
          commit_msg="üìä Sync trading data [$(date +'%Y-%m-%d %H:%M UTC')]"
          
          if [ -f "data/kraken_trades.csv" ]; then
            trades_count=$(tail -n +2 data/kraken_trades.csv | wc -l)
            commit_msg="${commit_msg}\n\n- Trades: ${trades_count}"
          fi
          
          if [ -f "data/trading_signals.csv" ]; then
            signals_count=$(tail -n +2 data/trading_signals.csv | wc -l)
            commit_msg="${commit_msg}\n- Signals: ${signals_count}"
          fi
          
          git commit -m "$(echo -e "$commit_msg")" || {
            echo "‚ö†Ô∏è No hay cambios para commitear"
            exit 0
          }
          
          git push || {
            echo "‚ùå Error al hacer push"
            exit 1
          }
          
          echo "‚úÖ Dashboard sincronizado"
      
      - name: Notify sync status
        if: always()
        env:
          TELEGRAM_API: ${{ secrets.TELEGRAM_API }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            status="‚úÖ Dashboard sincronizado"
          else
            status="‚ÑπÔ∏è Dashboard sin cambios"
          fi
          
          # Solo notificar si hubo cambios o es ejecuci√≥n manual
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_API}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="üåê ${status}" \
              -d parse_mode="Markdown" || echo "‚ö†Ô∏è No se pudo enviar notificaci√≥n"
          fi

  verify-dashboard:
    needs: sync-to-dashboard
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.inputs.force_sync == 'true'
    steps:
      - name: Checkout dashboard
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.DASHBOARD_REPO || format('{0}/{1}-dashboard', github.repository_owner, github.event.repository.name) }}
          token: ${{ secrets.DASHBOARD_TOKEN || secrets.GITHUB_TOKEN }}
      
      - name: Verify data integrity
        run: |
          echo "üîç Verificando integridad de datos..."
          
          errors=""
          
          # Verificar CSVs
          for file in data/*.csv; do
            if [ -f "$file" ]; then
              lines=$(wc -l < "$file")
              if [ "$lines" -lt 1 ]; then
                errors="${errors}‚ùå $file est√° vac√≠o\n"
              else
                echo "‚úÖ $file: $lines l√≠neas"
              fi
            fi
          done
          
          # Verificar metadata
          if [ -f "data/metadata.json" ]; then
            if ! python3 -m json.tool data/metadata.json > /dev/null 2>&1; then
              errors="${errors}‚ùå metadata.json tiene formato inv√°lido\n"
            else
              echo "‚úÖ metadata.json v√°lido"
            fi
          fi
          
          if [ -n "$errors" ]; then
            echo -e "$errors"
            exit 1
          fi
          
          echo "‚úÖ Todos los archivos v√°lidos"
