name: Trading Bot - Hourly Execution

on:
  schedule:
    - cron: '0 * * * *'  # Cada hora en punto
  workflow_dispatch:  # EjecuciÃ³n manual
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  # Job Ãºnico para evitar conflictos
  train-and-predict:
    runs-on: ubuntu-latest
    
    # Prevenir ejecuciones simultÃ¡neas
    concurrency:
      group: trading-bot
      cancel-in-progress: false
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -q yfinance scikit-learn torch tqdm matplotlib joblib requests pandas numpy schedule

      # FASE 1: Entrenamiento del modelo (solo si es push o manual)
      - name: Train LSTM Model
        if: github.event_name != 'schedule'
        run: python ethusd_lstm.py

      # FASE 2: PredicciÃ³n y seÃ±ales
      - name: Generate Predictions & Signals
        run: |
          if [ -f "predict_and_filter.py" ]; then
            python predict_and_filter.py
          else
            echo "âš ï¸ predict_and_filter.py not found, skipping"
          fi

      # FASE 3: Trading (solo si hay kraken_trader.py)
      - name: Execute Trading
        run: |
          if [ -f "kraken_trader.py" ]; then
            python kraken_trader.py
          else
            echo "âš ï¸ kraken_trader.py not found, skipping"
          fi

      # FASE 4: Commit y push con manejo de conflictos
      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # AÃ±adir todos los archivos generados
          git add -A
          
          # Verificar cambios
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit"
            exit 0
          fi

          # Commit con timestamp
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M UTC')
          git commit -m "ğŸ¤– Auto-update: Trading bot execution [$TIMESTAMP] [skip ci]" || {
            echo "Nothing to commit"
            exit 0
          }

          # Push con manejo de conflictos y retry
          echo "ğŸ“¤ Pushing changes..."
          max_retries=5
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            if git push origin main; then
              echo "âœ… Push successful!"
              exit 0
            else
              retry_count=$((retry_count + 1))
              echo "âš ï¸ Push failed (attempt $retry_count/$max_retries)"
              
              if [ $retry_count -lt $max_retries ]; then
                echo "ğŸ”„ Pulling and retrying..."
                sleep $((retry_count * 3))  # Backoff exponencial
                
                # Pull con estrategia de merge
                git pull origin main --no-rebase --strategy-option=ours || {
                  echo "âš ï¸ Resolving conflicts..."
                  # Mantener nuestros archivos en conflicto
                  git checkout --ours . 2>/dev/null || true
                  git add -A
                  git commit -m "ğŸ”§ Resolve conflicts - keep latest" || true
                }
              fi
            fi
          done
          
          echo "âŒ Failed to push after $max_retries attempts"
          # No fallar el job, solo alertar
          echo "::warning::Could not push changes after multiple attempts"
          exit 0
